# Документация страницы авторизации

## Содержание
1. [Общее описание](#общее-описание)
2. [Структура страниц](#структура-страниц)
3. [Формы и валидация](#формы-и-валидация)
4. [API-взаимодействие](#api-взаимодействие)
5. [Безопасность](#безопасность)
6. [Дизайн и верстка](#дизайн-и-верстка)
7. [Пользовательский опыт (UX)](#пользовательский-опыт-ux)
8. [Лучшие практики](#лучшие-практики)

## Общее описание

Данная документация описывает реализацию системы авторизации в блоге NoEon, построенном на базе Next.js (фронтенд) и Django (бэкенд). Система обеспечивает функционал входа в систему с использованием JWT токенов, а также защиту маршрутов администратора от несанкционированного доступа.

Система авторизации реализована на основе клиентского контекста React с управлением состоянием аутентификации и автоматическим обновлением JWT токенов. В текущей версии реализован только вход в систему, функционал регистрации и восстановления пароля отсутствует и предполагается, что администраторы создаются на стороне бэкенда.

## Структура страниц

### Файловая структура

Система авторизации состоит из следующих основных компонентов:

```
/frontend/src/app/login/                       # Страница авторизации
  ├── layout.tsx                               # Макет страницы с метаданными
  └── page.tsx                                 # Клиентский компонент страницы

/frontend/src/components/login/                # Компоненты для авторизации
  └── LoginForm.tsx                           # Форма авторизации

/frontend/src/components/auth/                 # Компоненты защиты маршрутов
  └── ProtectedRoute.tsx                      # Защита административных страниц

/frontend/src/contexts/                        # Контекст авторизации
  └── AuthContext.tsx                         # Провайдер состояния авторизации
```

### Архитектура системы авторизации

Система авторизации построена на следующих принципах:

1. **Контекст авторизации** - центральный компонент `AuthContext`, который:
   - Хранит состояние аутентификации (пользователь, токены, состояние загрузки)
   - Управляет JWT токенами (сохранение, обновление, удаление)
   - Предоставляет API для входа, выхода и обновления токенов

2. **Страница авторизации** - клиентский компонент, который:
   - Обрабатывает логику перенаправления для уже авторизованных пользователей
   - Показывает форму входа для неавторизованных пользователей
   - Поддерживает параметр `next` для возврата на запрошенную страницу после успешного входа

3. **Компонент защиты маршрутов** - `ProtectedRoute`, который:
   - Проверяет наличие авторизации для доступа к защищенным страницам
   - Перенаправляет неавторизованных пользователей на страницу входа
   - Реализует механизм "запоминания" запрошенной страницы через параметр `next`
   - Оптимизирует процесс проверки авторизации через временного пользователя

## Формы и валидация

### Структура формы авторизации

Форма авторизации реализована в компоненте `LoginForm.tsx` и содержит следующие элементы:

- **Поле email** (формат email, обязательное)
- **Поле пароля** (обязательное)
- **Кнопка входа** с обработкой состояния загрузки (loading)
- **Блок отображения ошибок**

### Управление состоянием формы

Форма использует следующие React-хуки для управления состоянием:

```jsx
const [email, setEmail] = useState("");
const [password, setPassword] = useState("");
const [isLoading, setIsLoading] = useState(false);
const [error, setError] = useState<string | null>(null);
```

- `email` и `password` - состояния для хранения значений полей формы
- `isLoading` - флаг, указывающий на процесс отправки запроса
- `error` - хранение сообщения об ошибке (если таковая есть)

Кроме того, компонент использует контекст авторизации и хук навигации:

```jsx
const { login } = useAuth();
const router = useRouter();
```

### Валидация формы

Валидация формы осуществляется на стороне клиента и включает простые проверки:

- Проверка на пустоту полей email и пароля
- Обработка ошибок сервера и отображение соответствующих сообщений

Пример проверки перед отправкой формы:

```jsx
if (!email || !password) {
  setError("Введите email и пароль");
  return;
}
```

## API-взаимодействие

### Запрос авторизации

Для авторизации форма отправляет POST-запрос на эндпоинт `/api/token/` бэкенда. Процесс отправки реализован через стандартный `fetch`:

```jsx
const response = await fetch("/api/token/", {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
  },
  body: JSON.stringify({
    email,
    password,
  }),
});

const data = await response.json();
```

### Структура ответа сервера

При успешной авторизации сервер возвращает JWT токены в формате JSON:

```json
{
  "access": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
  "refresh": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."
}
```

Где:
- `access` - краткосрочный токен доступа (обычно действует 15-60 минут)
- `refresh` - долгосрочный токен обновления (обычно действует до 14 дней)

### Обработка результата

После успешного получения токенов происходит следующая обработка:

1. Сохранение токенов через функцию `login` из контекста `AuthContext`:

```jsx
await login(data.access, data.refresh);
```

2. Перенаправление пользователя на целевую страницу или страницу по умолчанию:

```jsx
window.location.href = nextPath || "/";
```

Параметр `nextPath` получается из параметров URL через `useSearchParams`.

### Процесс хранения токенов

В контексте `AuthContext` процесс сохранения токенов включает:

1. Сохранение токенов в `localStorage`:

```jsx
localStorage.setItem("accessToken", access);
localStorage.setItem("refreshToken", refresh);
```

2. Декодирование токена для получения данных пользователя:

```jsx
const decodedToken = jwtDecode<DecodedJwt>(access);
setUser({
  id: decodedToken.user_id,
  email: decodedToken.email,
  username: decodedToken.username,
});
```

3. Обновление состояния аутентификации в контексте:

```jsx
setAccessToken(access);
```

## Безопасность

### Механизм JWT аутентификации

Система авторизации использует стандартный JWT (библиотека `jwt-decode`) для работы с токенами. В JWT-подходе реализованы следующие механизмы безопасности:

1. **Двухтокенная система**: использование кратковременных access-токенов и долгосрочных refresh-токенов минимизирует риск в случае компрометации токена

2. **Автоматическое обновление токена**: контекст `AuthContext` проверяет срок действия токена и автоматически обновляет его используя рефреш-токен

3. **Проверка срока действия**: перед использованием токена происходит проверка его срока действия и валидности:

```jsx
const currentTime = Math.floor(Date.now() / 1000);
const decodedToken = jwtDecode<DecodedJwt>(storedAccessToken);

// Если токен истек или скоро истечет
if (decodedToken.exp && decodedToken.exp < currentTime + 300) { // 5 минут запаса
  // Выполняем обновление токена
  await refreshToken();
}
```

4. **Защита от циклических редиректов**: реализован механизм предотвращения циклических перенаправлений, когда одна страница авторизации могла бы перенаправлять на другую страницу авторизации:

```jsx
// Предотвращение циклических редиректов
if (nextPath.includes('/admin/login')) {
  nextPath = '/admin';
}
```

### Хранение токенов

Токены хранятся в `localStorage` браузера, что представляет собой компромисс между безопасностью и удобством использования. Следует отметить, что это делает приложение потенциально уязвимым к XSS-атакам.

Альтернативным подходом было бы использование HTTP-only cookies для рефреш-токена, что может быть реализовано в будущих версиях.

## Дизайн и верстка

### Стилизация страницы авторизации

Страница авторизации использует Tailwind CSS для стилизации компонентов. Основные элементы дизайна включают:

1. **Поля ввода** с современным внешним видом:

```jsx
<input
  type="email"
  name="email"
  id="email"
  value={email}
  onChange={(e) => setEmail(e.target.value)}
  required
  className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-base"
  placeholder="Email"
/>
```

2. **Кнопка входа** с индикатором загрузки:

```jsx
<button
  type="submit"
  className="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
  disabled={isLoading}
>
  {isLoading ? (
    <>
      <svg
        className="animate-spin -ml-1 mr-2 h-4 w-4 text-white"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
      >
        <circle
          className="opacity-25"
          cx="12"
          cy="12"
          r="10"
          stroke="currentColor"
          strokeWidth="4"
        ></circle>
        <path
          className="opacity-75"
          fill="currentColor"
          d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
        ></path>
      </svg>
      Вход...
    </>
  ) : (
    "Войти"
  )}
</button>
```

3. **Блок ошибок** с выделением красным цветом:

```jsx
{error && (
  <div className="mt-4 bg-red-50 border-l-4 border-red-400 p-4">
    <div className="flex">
      <div className="flex-shrink-0">
        <svg
          className="h-5 w-5 text-red-400"
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 20 20"
          fill="currentColor"
          aria-hidden="true"
        >
          <path
            fillRule="evenodd"
            d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
            clipRule="evenodd"
          />
        </svg>
      </div>
      <div className="ml-3">
        <p className="text-sm text-red-700">{error}</p>
      </div>
    </div>
  </div>
)}
```

### Адаптивность

Страница авторизации имеет адаптивный дизайн благодаря классам Tailwind:

- Максимальная ширина формы ограничена (`max-w-md`)
- Центрирование по вертикали и горизонтали (`flex items-center justify-center min-h-screen`)
- Адаптивные отступы и размеры текста

## Пользовательский опыт (UX)

### Индикация состояния и обратная связь

Для улучшения пользовательского опыта в странице авторизации реализованы следующие элементы:

1. **Индикаторы загрузки**:
   - Анимированный спиннер во время процесса входа
   - Замена текста кнопки на "Вход..." при отправке запроса
   - Отдельный индикатор загрузки на странице при проверке авторизации

2. **Управление ошибками**:
   - Четкое отображение ошибок валидации
   - Обработка и понятный вывод сообщений об ошибках сервера
   - Выделение ошибок красным цветом с использованием иконок

### Редирект и переходы

В реализации страницы авторизации предусмотрены следующие механизмы переходов:

1. **Запоминание пути доступа**:
   - Сохранение запрошенной страницы через параметр `next`
   - Автоматическое перенаправление после успешного входа

2. **Предотвращение лишних действий**:
   - Если пользователь уже авторизован, страница автоматически перенаправляет на целевую страницу
   - Защита от циклических перенаправлений

## Лучшие практики

При разработке системы авторизации были внедрены следующие лучшие практики:

### 1. Разделение ответственности компонентов

- **Контекст авторизации** (управление токенами, состояние пользователя)
- **Компонент формы** (форма, валидация, отправка запроса)
- **Компонент защиты маршрутов** (проверка доступа, перенаправление)

### 2. Безопасность и защита данных

- Использование JWT токенов для безопасной аутентификации
- Разделение токенов на краткосрочные (access) и долгосрочные (refresh)
- Автоматическое обновление токенов для поддержания сессии

### 3. Оптимизация производительности

- Использование клиентского кэширования для состояния авторизации
- Минимизация числа запросов к серверу через токены
- Оптимизация логики проверки авторизации с использованием временного пользователя

### 4. Пользовательский опыт

- Индикаторы загрузки и состояния процесса
- Перенаправление с запоминанием исходной страницы
- Чёткая обратная связь при ошибках

### 5. Области для улучшения

- **Безопасность**: замена хранения данных в `localStorage` на HTTP-only cookies
- **Функционал**: реализация страниц регистрации и восстановления пароля
- **Доступность**: добавление возможности аутентификации через социальные сети
